{% extends 'albums/base.html' %}
{% block content %}
<h2>Данные из БД</h2>

<div class="mb-3">
  <input id="search" class="form-control" placeholder="Поиск по названию, исполнителю, жанру, стране...">
</div>

<table class="table table-striped" id="albums-table">
  <thead>
    <tr>
      <th>Название</th>
      <th>Исполнитель</th>
      <th>Год</th>
      <th>Жанр</th>
      <th>Страна</th>
      <th>Треков</th>
      <th>Действия</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div class="modal fade" id="editModal" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">

      <div class="modal-header">
        <h5 class="modal-title">Редактировать альбом</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body">
        <input type="hidden" id="edit-id">

        <div class="mb-2">
          <label>Название</label>
          <input class="form-control" id="edit-title">
        </div>

        <div class="mb-2">
          <label>Исполнитель</label>
          <input class="form-control" id="edit-artist">
        </div>

        <div class="mb-2">
          <label>Год</label>
          <input type="number" class="form-control" id="edit-year">
        </div>

        <div class="mb-2">
          <label>Жанр</label>
          <input class="form-control" id="edit-genre">
        </div>

        <div class="mb-2">
          <label>Страна</label>
          <input class="form-control" id="edit-country">
        </div>

        <div class="mb-2">
          <label>Треков</label>
          <input type="number" class="form-control" id="edit-tracks">
        </div>

        <div class="alert alert-danger d-none" id="edit-error"></div>
      </div>

      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
        <button class="btn btn-primary" id="saveEditBtn">Сохранить</button>
      </div>

    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {

  const tableBody = document.querySelector('#albums-table tbody');
  const searchInput = document.getElementById('search');

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  async function loadResults() {
    const q = searchInput.value;
    const resp = await fetch("{% url 'albums:api_search_albums' %}?q=" + encodeURIComponent(q));
    const data = await resp.json();
    renderRows(data.results || []);
  }

  function renderRows(items) {
    tableBody.innerHTML = '';

    if (!items.length) {
      tableBody.innerHTML = `<tr><td colspan="7" class="text-center">Нет записей</td></tr>`;
      return;
    }

    items.forEach(item => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${item.title}</td>
        <td>${item.artist}</td>
        <td>${item.year}</td>
        <td>${item.genre}</td>
        <td>${item.country}</td>
        <td>${item.tracks}</td>
        <td>
          <button class="btn btn-sm btn-warning" onclick="openEdit(${item.id}, this)">Редактировать</button>
          <button class="btn btn-sm btn-danger" onclick="deleteAlbum(${item.id})">Удалить</button>
        </td>
      `;
      tableBody.appendChild(tr);
    });
  }

  window.deleteAlbum = async function(id) {
    if (!confirm('Удалить запись?')) return;

    const resp = await fetch(`/api/db/${id}/delete/`, {
      method: 'POST',
      headers: {'X-CSRFToken': csrftoken},
    });

    const data = await resp.json();
    if (data.ok) loadResults();
    else alert(data.error || 'Ошибка при удалении');
  }

  let editModal = null;
  if (window.bootstrap) {
    editModal = new bootstrap.Modal(document.getElementById('editModal'));
  }

  window.openEdit = function(id, btn) {
    const row = btn.closest('tr').children;

    document.getElementById('edit-id').value = id;
    document.getElementById('edit-title').value = row[0].textContent;
    document.getElementById('edit-artist').value = row[1].textContent;
    document.getElementById('edit-year').value = row[2].textContent;
    document.getElementById('edit-genre').value = row[3].textContent;
    document.getElementById('edit-country').value = row[4].textContent;
    document.getElementById('edit-tracks').value = row[5].textContent;

    document.getElementById('edit-error').classList.add('d-none');

    editModal.show();
  }

  document.getElementById('saveEditBtn').onclick = async () => {
    const id = document.getElementById('edit-id').value;

    const payload = {
      title: document.getElementById('edit-title').value,
      artist: document.getElementById('edit-artist').value,
      year: document.getElementById('edit-year').value,
      genre: document.getElementById('edit-genre').value,
      country: document.getElementById('edit-country').value,
      tracks: document.getElementById('edit-tracks').value,
    };

    const resp = await fetch(`/api/db/${id}/edit/`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': csrftoken,
      },
      body: JSON.stringify(payload),
    });

    const data = await resp.json();
    if (data.ok) {
      editModal.hide();
      loadResults();
    } else {
      const box = document.getElementById('edit-error');
      box.textContent = data.error || 'Ошибка сохранения';
      box.classList.remove('d-none');
    }
  }

  searchInput.addEventListener('input', loadResults);
  loadResults();

});
</script>



{% endblock %}
